<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>New Market v16.6.3 - Paulo Souza</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{font-family:sans-serif;background:#f8fafc}
.hidden{display:none!important}
.bg-empresa{background:#003366}
.pulse{width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(74,222,128,.7)}70%{box-shadow:0 0 0 8px rgba(74,222,128,0)}100%{box-shadow:0 0 0 0 rgba(74,222,128,0)}}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginView" class="fixed inset-0 bg-[#003366] flex items-center justify-center">
  <div class="bg-white w-full max-w-sm rounded-3xl p-8">
    <h2 class="text-center font-black mb-6">Controle de Equipe</h2>
    <div id="lista-usuarios" class="space-y-2"></div>
  </div>
</div>

<!-- MODAL SENHA -->
<div id="modal-senha" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-2xl w-full max-w-xs text-center">
    <h3 id="nome-selecionado" class="font-black mb-4"></h3>
    <input id="input-senha" type="password" class="w-full p-4 bg-slate-100 rounded-xl mb-4 text-center">
    <div class="flex gap-2">
      <button onclick="fecharSenha()" class="flex-1 bg-slate-200 p-3 rounded-xl">Cancelar</button>
      <button id="btn-confirmar-senha" class="flex-1 bg-[#003366] text-white p-3 rounded-xl">OK</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appView" class="hidden">

<header class="bg-[#003366] p-5 text-white">
  <div class="flex justify-between items-center">
    <div>
      <h1 class="font-black text-xl text-yellow-400">New Market</h1>
      <div class="flex items-center gap-2 text-xs">
        <span class="pulse"></span>
        <span id="user-display"></span>
      </div>
    </div>
    <button onclick="logout()">ðŸšª</button>
  </div>
  <input id="input-busca" oninput="renderizar()" placeholder="Buscar..." class="w-full mt-4 p-3 rounded-xl text-black">
</header>

<main class="p-5 max-w-lg mx-auto">
  <div id="container-produtos" class="space-y-3"></div>
</main>

<button onclick="abrirCadastro()" class="fixed bottom-6 left-6 right-6 bg-yellow-400 p-4 rounded-xl font-black">
+ CADASTRAR PRODUTO
</button>

</div>

<!-- MODAL CADASTRO -->
<div id="modal-cadastro" class="hidden fixed inset-0 bg-white z-50 overflow-y-auto p-6">
  <h2 class="font-black mb-4">Cadastro</h2>
  <div id="reader" class="mb-4"></div>
  <input id="p-ean" placeholder="EAN" class="w-full p-3 bg-slate-100 rounded mb-2">
  <input id="p-nome" placeholder="Produto" class="w-full p-3 bg-slate-100 rounded mb-2">
  <input id="p-validade" type="date" class="w-full p-3 bg-slate-100 rounded mb-2">
  <input id="p-qtd" type="number" placeholder="Qtd" class="w-full p-3 bg-slate-100 rounded mb-4">
  <input id="edit-id" type="hidden">
  <button onclick="salvarProduto()" class="w-full bg-[#003366] text-white p-4 rounded-xl mb-2">Salvar</button>
  <button onclick="fecharModalCadastro()" class="w-full text-center text-slate-400">Cancelar</button>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyAJaG7s34jBoU61fNNZieeV3N6lh9_3vo4",
authDomain:"mercado-c3e95.firebaseapp.com",
projectId:"mercado-c3e95"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const EQUIPE=[
{nome:"PAULO",pass:"paulo123"},
{nome:"PEDRO",pass:"pedro123"}
];

let usuarioSessao=null;
let estoque=[];
let scanner=null;

window.onload=()=>{
const lista=document.getElementById("lista-usuarios");
EQUIPE.forEach(u=>{
lista.innerHTML+=`<button onclick="login('${u.nome}')" class="w-full p-3 bg-slate-100 rounded-xl font-black">${u.nome}</button>`;
});
};

function login(nome){
document.getElementById("nome-selecionado").innerText=nome;
document.getElementById("modal-senha").classList.remove("hidden");
document.getElementById("btn-confirmar-senha").onclick=()=>{
const u=EQUIPE.find(x=>x.nome===nome);
if(document.getElementById("input-senha").value===u.pass){
usuarioSessao=u;
localStorage.setItem("sessao",nome);
entrar();
}else alert("Senha incorreta");
};
}

function entrar(){
fecharSenha();
document.getElementById("loginView").classList.add("hidden");
document.getElementById("appView").classList.remove("hidden");
document.getElementById("user-display").innerText=usuarioSessao.nome;
db.collection("validades").onSnapshot(s=>{
estoque=[];
s.forEach(d=>estoque.push({id:d.id,...d.data()}));
renderizar();
});
}

function renderizar(){
const c=document.getElementById("container-produtos");
const b=document.getElementById("input-busca").value.toUpperCase();
c.innerHTML="";
estoque.filter(i=>(i.produto||"").includes(b)).forEach(i=>{
c.innerHTML+=`
<div class="bg-white p-4 rounded-xl shadow">
<p class="font-black">${i.produto}</p>
<p class="text-xs">Val: ${i.vencimento}</p>
<p class="font-black">Qtd: ${i.quantidade}</p>
<button onclick="editar('${i.id}')" class="text-blue-500 text-xs mt-2">Editar</button>
</div>`;
});
}

function editar(id){
const p=estoque.find(x=>x.id===id);
abrirCadastro();
document.getElementById("edit-id").value=id;
document.getElementById("p-ean").value=p.ean||"";
document.getElementById("p-nome").value=p.produto;
document.getElementById("p-validade").value=p.vencimento;
document.getElementById("p-qtd").value=p.quantidade;
}

function abrirCadastro(){
document.getElementById("modal-cadastro").classList.remove("hidden");
scanner=new Html5Qrcode("reader");
scanner.start({facingMode:"environment"},{fps:10,qrbox:250},txt=>{
document.getElementById("p-ean").value=txt;
scanner.stop();
});
}

function fecharModalCadastro(){
document.getElementById("modal-cadastro").classList.add("hidden");
if(scanner){scanner.stop().catch(()=>{});}
}

async function salvarProduto(){
const id=document.getElementById("edit-id").value;
const dados={
ean:p-ean.value,
produto:p-nome.value.toUpperCase(),
vencimento:p-validade.value,
quantidade:+p-qtd.value||0
};
if(id) await db.collection("validades").doc(id).update(dados);
else await db.collection("validades").add(dados);
fecharModalCadastro();
}

function fecharSenha(){
document.getElementById("modal-senha").classList.add("hidden");
document.getElementById("input-senha").value="";
}

function logout(){
localStorage.clear();
location.reload();
}
</script>

</body>
</html>
