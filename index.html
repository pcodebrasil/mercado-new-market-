<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>New Market - Gest√£o de Validade</title>

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignal.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "b506dbfa-b632-41c1-a56c-c3ed0ac2c709",
          safari_web_id: "web.onesignal.auto.63584824-3450-4886-9818-875654",
          notifyButton: { enable: false },
        });
      });
    </script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #16a34a;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

        /* Login */
        #login-screen {
            position: fixed; inset: 0; background: var(--primary);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .login-card {
            background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; text-align: center;
        }
        .login-card h2 { color: var(--primary); margin-bottom: 1.5rem; }
        input { width: 100%; padding: 0.8rem; margin-bottom: 1.1rem; border: 1px solid #ddd; border-radius: 0.5rem; outline: none; }
        button { width: 100%; padding: 0.8rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-purple { background: #6b21a8; color: white; margin-top: 1rem; }

        /* Header */
        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        
        /* Containers */
        .container { padding: 1rem; max-width: 800px; margin: 0 auto; }
        .card { background: var(--card); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #ddd; }
        
        /* Status Validade */
        .status-vencido { border-left-color: var(--danger); background: #fef2f2; }
        .status-critico { border-left-color: var(--warning); background: #fffbeb; }
        .status-ok { border-left-color: var(--success); }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 200; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 500px; }

        /* Navega√ß√£o */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 1rem; border-top: 1px solid #ddd; }
        nav button { background: none; color: #64748b; font-size: 0.8rem; }
        nav button.active { color: var(--primary); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>New Market</h2>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="password" placeholder="Senha">
            <button class="btn-primary" onclick="login()">Entrar no Sistema</button>
        </div>
    </div>

    <header>
        <span id="user-display">New Market</span>
        <button onclick="document.getElementById('modal-config').style.display='flex'" style="background:none; font-size: 1.5rem;">‚öôÔ∏è</button>
    </header>

    <div class="container" id="main-content">
        <div id="lista-produtos"></div>
    </div>

    <nav>
        <button onclick="showSection('lista')" id="nav-lista" class="active">üìã Lista</button>
        <button onclick="showSection('add')">‚ûï Lan√ßar</button>
        <button onclick="logout()">üö™ Sair</button>
    </nav>

    <div id="modal-add" class="modal">
        <div class="modal-content">
            <h3>Lan√ßar Produto</h3><br>
            <input type="text" id="prod-nome" placeholder="Nome do Produto">
            <input type="date" id="prod-validade">
            <input type="text" id="prod-setor" placeholder="Setor (ex: Latic√≠nios)">
            <button class="btn-primary" onclick="salvarProduto()">Salvar no Sistema</button>
            <button onclick="this.parentElement.parentElement.style.display='none'" style="margin-top:0.5rem; background:none; color: gray;">Cancelar</button>
        </div>
    </div>

    <div id="modal-config" class="modal">
        <div class="modal-content">
            <h3>Configura√ß√µes</h3>
            <p style="font-size: 0.8rem; color: gray; margin-bottom: 1rem;">Ative as notifica√ß√µes para receber alertas de validade.</p>
            <button class="btn-purple" onclick="ativarNotificacoes()">üîî Ativar Alertas no Celular</button>
            <button onclick="this.parentElement.parentElement.style.display='none'" style="margin-top:1rem; background:#ddd;">Fechar</button>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE CORRIGIDA
        const firebaseConfig = {
            apiKey: "AIzaSyBw-vKjG9v8z7Y6x5w4v3u2t1s0r9q8p7",
            authDomain: "mercado-new-market.firebaseapp.com",
            projectId: "mercado-new-market",
            storageBucket: "mercado-new-market.appspot.com",
            messagingSenderId: "305139046648",
            appId: "1:305139046648:web:7417e30d170f86230f6063"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, pass)
                .catch(err => alert("Erro ao entrar: Verifique e-mail e senha."));
        }

        function logout() { auth.signOut().then(() => location.reload()); }

        function showSection(section) {
            if(section === 'add') document.getElementById('modal-add').style.display = 'flex';
            else carregarProdutos();
        }

        function ativarNotificacoes() {
            OneSignalDeferred.push(function(OneSignal) { OneSignal.showNativePrompt(); });
        }

        function salvarProduto() {
            const nome = document.getElementById('prod-nome').value;
            const validade = document.getElementById('prod-validade').value;
            const setor = document.getElementById('prod-setor').value;
            if(!nome || !validade) return alert("Preencha os campos!");

            db.collection("produtos").add({
                nome, validade, setor,
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
                usuario: auth.currentUser.email
            }).then(() => {
                document.getElementById('modal-add').style.display = 'none';
                carregarProdutos();
            });
        }

        function carregarProdutos() {
            db.collection("produtos").orderBy("validade", "asc").onSnapshot(snap => {
                const lista = document.getElementById('lista-produtos');
                lista.innerHTML = "";
                snap.forEach(doc => {
                    const p = doc.data();
                    const hoje = new Date();
                    const venv = new Date(p.validade);
                    const diff = Math.ceil((venv - hoje) / (1000 * 60 * 60 * 24));
                    let statusClass = diff <= 0 ? "status-vencido" : (diff <= 7 ? "status-critico" : "status-ok");
                    
                    lista.innerHTML += `
                        <div class="card ${statusClass}">
                            <strong>${p.nome}</strong><br>
                            <small>Setor: ${p.setor || 'Geral'}</small><br>
                            <span style="font-weight:bold">${p.validade}</span> - ${diff <= 0 ? '‚ùå VENCIDO' : diff + ' dias'}
                            <button onclick="excluirProd('${doc.id}')" style="width:auto; float:right; background:none; color:red">üóëÔ∏è</button>
                        </div>`;
                });
            });
        }

        function excluirProd(id) { if(confirm("Remover produto?")) db.collection("produtos").doc(id).delete(); }

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('user-display').innerText = user.email.split('@')[0];
                carregarProdutos();
            }
        });
    </script>
</body>
</html>
