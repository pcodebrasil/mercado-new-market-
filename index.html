<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New Market v17.0</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{background:#f8fafc;font-family:sans-serif}
.hidden{display:none!important}
.pulse{width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(74,222,128,.7)}70%{box-shadow:0 0 0 8px rgba(74,222,128,0)}100%{box-shadow:0 0 0 0 rgba(74,222,128,0)}}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginView" class="fixed inset-0 bg-[#003366] flex items-center justify-center">
  <div class="bg-white w-full max-w-sm p-8 rounded-3xl">
    <h2 class="font-black text-center mb-6">Controle de Equipe</h2>
    <div id="lista-usuarios" class="space-y-2"></div>
  </div>
</div>

<!-- MODAL SENHA -->
<div id="modalSenha" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-2xl w-full max-w-xs text-center">
    <h3 id="nomeLogin" class="font-black mb-4"></h3>
    <input id="senhaLogin" type="password" class="w-full p-4 bg-slate-100 rounded-xl mb-4 text-center">
    <button id="confirmarSenha" class="w-full bg-[#003366] text-white p-3 rounded-xl">Entrar</button>
  </div>
</div>

<!-- APP -->
<div id="appView" class="hidden">

<header class="bg-[#003366] p-5 text-white">
  <div class="flex justify-between">
    <div>
      <h1 class="font-black text-xl text-yellow-400">New Market</h1>
      <div class="flex items-center gap-2 text-xs">
        <span class="pulse"></span>
        <span id="userDisplay"></span>
      </div>
    </div>
    <button onclick="logout()">ðŸšª</button>
  </div>

  <div class="grid grid-cols-3 gap-2 mt-4 text-center">
    <div class="bg-red-600 p-2 rounded-xl">
      <p class="text-[9px] uppercase">Vencidos</p>
      <p id="dashV" class="font-black text-lg">0</p>
    </div>
    <div class="bg-yellow-400 p-2 rounded-xl text-black">
      <p class="text-[9px] uppercase">Alerta</p>
      <p id="dashA" class="font-black text-lg">0</p>
    </div>
    <div class="bg-white text-black p-2 rounded-xl">
      <p class="text-[9px] uppercase">Total</p>
      <p id="dashT" class="font-black text-lg">0</p>
    </div>
  </div>

  <input id="busca" oninput="renderizar()" placeholder="Buscar..." class="w-full mt-4 p-3 rounded-xl text-black">
</header>

<main class="p-5 max-w-lg mx-auto space-y-3" id="listaProdutos"></main>

<button onclick="abrirCadastro()" class="fixed bottom-6 left-6 right-6 bg-yellow-400 p-4 rounded-xl font-black">
+ CADASTRAR
</button>

<button onclick="gerarRelatorio()" id="btnRelatorio" class="hidden fixed bottom-20 left-6 right-6 bg-emerald-600 text-white p-3 rounded-xl font-black">
ðŸ“„ GERAR RELATÃ“RIO
</button>

</div>

<!-- MODAL CADASTRO -->
<div id="modalCadastro" class="hidden fixed inset-0 bg-white z-50 p-6 overflow-y-auto">
  <h2 class="font-black mb-4">Cadastro</h2>
  <div id="reader" class="mb-4"></div>
  <input id="ean" placeholder="EAN" class="w-full p-3 bg-slate-100 rounded mb-2">
  <input id="produto" placeholder="Produto" class="w-full p-3 bg-slate-100 rounded mb-2">
  <input id="validade" type="date" class="w-full p-3 bg-slate-100 rounded mb-2">
  <input id="qtd" type="number" placeholder="Qtd" class="w-full p-3 bg-slate-100 rounded mb-4">
  <input id="editId" type="hidden">
  <button onclick="salvar()" class="w-full bg-[#003366] text-white p-4 rounded-xl">Salvar</button>
  <button onclick="fecharCadastro()" class="w-full text-slate-400 mt-3">Cancelar</button>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAJaG7s34jBoU61fNNZieeV3N6lh9_3vo4",authDomain:"mercado-c3e95.firebaseapp.com",projectId:"mercado-c3e95"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const USUARIOS=[
{nome:"PAULO",cargo:"GERENTE",senha:"paulo123"},
{nome:"PEDRO",cargo:"EQUIPE",senha:"pedro123"},
{nome:"VISUAL",cargo:"VISUAL",senha:"123"}
];

let user=null,estoque=[],scanner=null;

window.onload=()=>{
const l=document.getElementById("lista-usuarios");
USUARIOS.forEach(u=>{
l.innerHTML+=`<button onclick="login('${u.nome}')" class="w-full p-3 bg-slate-100 rounded-xl font-black">${u.nome}</button>`;
});
};

function login(nome){
document.getElementById("nomeLogin").innerText=nome;
document.getElementById("modalSenha").classList.remove("hidden");
document.getElementById("confirmarSenha").onclick=()=>{
const u=USUARIOS.find(x=>x.nome===nome);
if(senhaLogin.value===u.senha){user=u;entrar();}
else alert("Senha incorreta");
};
}

function entrar(){
modalSenha.classList.add("hidden");
loginView.classList.add("hidden");
appView.classList.remove("hidden");
userDisplay.innerText=`${user.nome} (${user.cargo})`;
db.collection("validades").onSnapshot(s=>{
estoque=[];
s.forEach(d=>estoque.push({id:d.id,...d.data()}));
renderizar();
});
}

function renderizar(){
const l=listaProdutos,b=busca.value.toUpperCase();
let v=0,a=0;
l.innerHTML="";
estoque.filter(i=>(i.produto||"").includes(b)).forEach(i=>{
const dias=Math.ceil((new Date(i.validade)-new Date())/86400000);
if(dias<0)v++; else if(dias<=7)a++;
l.innerHTML+=`
<div class="bg-white p-4 rounded-xl shadow">
<p class="font-black">${i.produto}</p>
<p class="text-xs">Val: ${i.validade}</p>
<p class="font-black">Qtd: ${i.qtd}</p>
${user.cargo!=="VISUAL"?`<button onclick="editar('${i.id}')" class="text-blue-500 text-xs mt-2">Editar</button>`:""}
${user.cargo==="GERENTE"?`<button onclick="excluir('${i.id}')" class="text-red-500 text-xs mt-2 ml-2">Excluir</button>`:""}
</div>`;
});
dashV.innerText=v;dashA.innerText=a;dashT.innerText=estoque.length;
(v||a)?btnRelatorio.classList.remove("hidden"):btnRelatorio.classList.add("hidden");
}

function abrirCadastro(){
if(user.cargo==="VISUAL")return;
modalCadastro.classList.remove("hidden");
scanner=new Html5Qrcode("reader");
scanner.start({facingMode:"environment"},{fps:10,qrbox:250},txt=>{
ean.value=txt;scanner.stop();
});
}

function fecharCadastro(){
modalCadastro.classList.add("hidden");
if(scanner)scanner.stop().catch(()=>{});
}

async function salvar(){
const dados={ean:ean.value,produto:produto.value.toUpperCase(),validade:validade.value,qtd:+qtd.value||0};
if(editId.value)await db.collection("validades").doc(editId.value).update(dados);
else await db.collection("validades").add(dados);
fecharCadastro();
}

function editar(id){
const p=estoque.find(x=>x.id===id);
abrirCadastro();
editId.value=id;
ean.value=p.ean;produto.value=p.produto;validade.value=p.validade;qtd.value=p.qtd;
}

async function excluir(id){
if(user.cargo!=="GERENTE")return;
if(confirm("Excluir item?"))await db.collection("validades").doc(id).delete();
}

function gerarRelatorio(){
let t=`RELATÃ“RIO NEW MARKET\nResponsÃ¡vel: ${user.nome}\n\n`;
estoque.filter(i=>{
const d=Math.ceil((new Date(i.validade)-new Date())/86400000);
return d<=7;
}).forEach(i=>{
t+=`â€¢ ${i.produto} (${i.qtd}) - ${i.validade}\n`;
});
navigator.share?navigator.share({text:t}):alert(t);
}

function logout(){location.reload();}
</script>

</body>
</html>
